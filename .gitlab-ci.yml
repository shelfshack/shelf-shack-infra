stages:
  - plan
  - apply

variables:
  TF_ROOT: ${CI_PROJECT_DIR}/envs/dev
  BACKEND_REPO_PATH: ${CI_PROJECT_DIR}/../shelf-shack-backend

terraform:plan:
  stage: plan
  image: hashicorp/terraform:1.5.0
  before_script:
    - cd ${TF_ROOT}
    - terraform --version
    - terraform init
  script:
    - |
      # Clone backend repo if not already present
      if [ ! -d "${BACKEND_REPO_PATH}" ]; then
        git clone ${BACKEND_REPO_URL} ${BACKEND_REPO_PATH} || true
      fi
    - |
      terraform plan \
        -var="websocket_lambda_source_file=${BACKEND_REPO_PATH}/lambda/websocket_proxy.py" \
        -out=tfplan
  artifacts:
    paths:
      - ${TF_ROOT}/tfplan
    expire_in: 1 week
  only:
    - merge_requests
    - develop
    - main

terraform:apply:
  stage: apply
  image: hashicorp/terraform:1.5.0
  before_script:
    - cd ${TF_ROOT}
    - terraform init
  script:
    - |
      # Clone backend repo if not already present
      if [ ! -d "${BACKEND_REPO_PATH}" ]; then
        git clone ${BACKEND_REPO_URL} ${BACKEND_REPO_PATH} || true
      fi
    - |
      terraform apply \
        -var="websocket_lambda_source_file=${BACKEND_REPO_PATH}/lambda/websocket_proxy.py" \
        -auto-approve
  only:
    - main
  when: manual



